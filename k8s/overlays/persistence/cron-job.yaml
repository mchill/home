apiVersion: batch/v1
kind: CronJob
metadata:
  name: $(VOLUME)-backup
spec:
  schedule: "@daily"
  concurrencyPolicy: Forbid
  successfulJobsHistoryLimit: 0
  failedJobsHistoryLimit: 0
  jobTemplate:
    spec:
      backoffLimit: 0
      template:
        spec:
          restartPolicy: OnFailure
          affinity:
            podAffinity:
              requiredDuringSchedulingIgnoredDuringExecution:
                - topologyKey: "kubernetes.io/hostname"
                  labelSelector:
                    matchExpressions:
                      - key: app
                        operator: In
                        values:
                          - $(VOLUME)
          containers:
            - name: backup
              image: bash:5.2.37
              args:
                - /bin/sh
                - -cex
                - |
                  apk add --no-cache rsync;
                  command -v getfacl || apk add acl;
                  cd /backup;
                  getfacl -R ${VOLUME} > ${VOLUME}.facl;
                  rsync -avz --delete-before /backup/${VOLUME}.facl /target/${VOLUME}.facl;
                  rsync -avz --delete-before /backup/${VOLUME} /target;
              env:
                - name: TZ
                  value: America/New_York
                - name: VOLUME
                  value: $(VOLUME)
              volumeMounts:
                - name: data
                  readOnly: true
                  mountPath: /backup/$(VOLUME)
                - name: applications
                  mountPath: /target
                  subPath: backup
          volumes:
            - name: data
              persistentVolumeClaim:
                claimName: $(VOLUME)
            - name: applications
              persistentVolumeClaim:
                claimName: applications
