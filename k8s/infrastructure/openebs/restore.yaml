apiVersion: batch/v1
kind: Job
metadata:
  name: restore
  namespace: server
spec:
  backoffLimit: 1
  template:
    spec:
      restartPolicy: Never
      containers:
      - name: restore
        image: alpine@sha256:69e70a79f2d41ab5d637de98c1e0b055206ba40a8145e7bddb55ccc04e13cf8f
        securityContext:
          privileged: true
        args:
          - /bin/sh
          - -cex
          - |
            apk add rsync
            mkdir /mnt/old
            mount -o rw -t ext4 /var/openebs/old/volume-head-000.img /mnt/old
            rsync -ah --progress /mnt/old/ /mnt/new
            umount /mnt/old
        env:
          - name: TZ
            value: America/New_York
        volumeMounts:
          - name: old
            readOnly: true
            mountPath: /var/openebs/old
            subPath: $OLD_VOLUME_NAME
          - name: new
            mountPath: /mnt/new
      volumes:
        - name: old
          hostPath:
            path: /var/openebs
        - name: new
          persistentVolumeClaim:
            claimName: server
